<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw or CONCURSO Results</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="app-shell">
    <script src="../auth.js"></script>
    <script>ensureAuthenticated();</script>

    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="brand-mark">Q2</div>
            <div>
                <p class="eyebrow">Admin</p>
                <strong>Operations</strong>
            </div>
        </div>
        <div class="sidebar-section">
            <p class="sidebar-label">Overview</p>
            <a href="../index.html">Dashboard</a>
        </div>
        <div class="sidebar-section">
            <p class="sidebar-label">Operations</p>
            <a href="entries.html">Entries</a>
            <a href="results.html" class="active">Results</a>
            <a href="winners.html">Winners</a>
        </div>
        <div class="sidebar-footer">
            <button class="btn-ghost logout-btn" onclick="logout()">Logout</button>
        </div>
    </aside>

    <div class="main-panel">
        <div class="topbar">
            <div>
                <p class="eyebrow">Admin Console</p>
                <h1>Draw or CONCURSO Results</h1>
                <p class="muted" id="accountBanner">Logged in as: â€”</p>
            </div>
            <div class="actions-row">
                <button id="refreshBtn" class="btn-refresh">Refresh</button>
                <button class="btn-danger ghost" onclick="logout()">Logout</button>
            </div>
        </div>

        <main class="content">
            <div class="section">
                <div class="section-header">
                    <div>
                        <p class="eyebrow">Fonte: (read-only)</p>
                        <h2>Draw or CONCURSO Results</h2>
                    </div>
                    <div class="actions-row">
                        <button id="refreshBtn" class="btn-refresh">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container compact">
                    <table id="resultsTable">
                        <colgroup>
                            <col style="min-width: 120px;">
                            <col style="min-width: 140px;">
                            <col style="min-width: 200px;">
                            <col style="min-width: 180px;">
                            <col style="min-width: 140px;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>CONCURSO</th>
                                <th>DRAW DATE</th>
                                <th>WINNING NUMBERS</th>
                                <th>REFRESHED AT</th>
                                <th>SRC</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="footer-bar">
            <p>Last Updated: <span id="lastUpdate">Never</span></p>
        </footer>
    </div>

    <script src="../results-fetcher.js"></script>
    <script src="../data-fetcher.js"></script>
    <script src="../validator.js"></script>
    <script>
        async function init() {
            await dataFetcher.fetchData();
            const results = await resultsFetcher.fetchResults();
            validator.setResults(results);
            displayResults();
            updateLastUpdateTime();
            setAccountBanner();
            setupEventListeners();
        }

        function displayResults() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            const results = validator.getAllResults();
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum resultado encontrado no Google Sheet</td></tr>';
                return;
            }
            
            results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="badge badge-primary">${result.contest}</span></td>
                    <td>${result.drawDate}</td>
                    <td><strong style="font-size: 18px; color: #1e3c72;">${result.winningNumbers.join(', ')}</strong></td>
                    <td>${new Date(result.savedAt).toLocaleString('pt-BR')}</td>
                    <td><span class="badge badge-validated">RESULT Sheet</span></td>
                `;
            });
        }

        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', init);
        }

        function setAccountBanner() {
            const banner = document.getElementById('accountBanner');
            if (!banner || typeof getSession !== 'function') return;
            const session = getSession();
            banner.textContent = session && session.account ? `Logged in as: ${session.account}` : 'Logged in as: (session missing)';
        }

        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (resultsFetcher.lastFetchTime) {
                lastUpdate.textContent = resultsFetcher.lastFetchTime.toLocaleString('pt-BR');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>